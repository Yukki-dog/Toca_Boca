<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ú–∏—Ä –ö–≤–∞—Ä—Ç–∏—Ä—ã ‚Äî –ø—Ä–æ—Ç–æ—Ç–∏–ø</title>
<style>
  /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
  body, html {
    margin: 0; padding: 0; height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f0f5;
    overflow: hidden;
  }
  #app {
    display: flex; height: 100vh; width: 100vw; position: relative;
  }

  /* –ö–≤–∞—Ä—Ç–∏—Ä–∞ (–æ—Å–Ω–æ–≤–Ω–æ–µ –æ–∫–Ω–æ) */
  #apartment {
    flex-grow: 1;
    background: linear-gradient(135deg, #ffe6cc, #ffe3f2);
    position: relative;
    overflow: hidden;
    display: flex; flex-direction: column;
  }
  #room-name {
    text-align: center;
    font-weight: 700;
    padding: 8px 0;
    background: #ffe3f2;
    border-bottom: 2px solid #cc6699;
    user-select: none;
  }
  #room-content {
    flex-grow: 1;
    position: relative;
    background: white;
    margin: 12px;
    border-radius: 12px;
    box-shadow: 0 0 16px rgba(204,102,153,0.3);
    overflow: hidden;
  }

  /* –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç */
  #room-controls {
    display: flex;
    justify-content: center;
    gap: 12px;
    padding-bottom: 8px;
  }
  #room-controls button {
    background: #cc6699;
    border: none;
    border-radius: 6px;
    color: white;
    font-weight: 700;
    padding: 8px 16px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #room-controls button:hover {
    background: #b2547f;
  }

  /* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É */
  #add-room-btn {
    background: #6aafaf;
  }
  #add-room-btn:hover {
    background: #4c8c8c;
  }

  /* –ü–∞–Ω–µ–ª—å –º–µ–±–µ–ª–∏ */
  #furniture-panel {
    width: 300px;
    background: rgba(255 255 255 / 0.85);
    box-shadow: 0 0 20px rgba(102,51,77,0.3);
    backdrop-filter: blur(8px);
    border-left: 2px solid #cc6699;
    padding: 16px;
    overflow-y: auto;
    position: absolute;
    top: 0; bottom: 0; left: 0;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    z-index: 10;
  }
  #furniture-panel.open {
    transform: translateX(0);
  }
  #furniture-panel h3 {
    margin-top: 0;
    color: #6a4a6a;
  }
  #furniture-list {
    display: flex; flex-wrap: wrap; gap: 10px;
  }
  .furniture-item {
    background: #cc6699;
    color: white;
    border-radius: 8px;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    font-weight: 700;
    cursor: grab;
    box-shadow: 0 4px 8px rgba(204,102,153,0.5);
  }

  /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç—å –º–µ–±–µ–ª—å */
  #furniture-close {
    position: absolute;
    top: 8px; right: 8px;
    background: #cc6699;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px; height: 30px;
    font-weight: 700;
    cursor: pointer;
  }

  /* –í–µ—Ä—Ö–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ü—Ä–æ—Ñ–∏–ª—å –∏ –ú–µ–±–µ–ª—å */
  #top-buttons {
    position: absolute;
    top: 12px;
    left: 12px;
    display: flex;
    gap: 8px;
    z-index: 15;
  }
  .side-btn {
    background: #cc6699;
    color: white;
    border: none;
    border-radius: 20px;
    width: 40px;
    height: 40px;
    font-weight: 700;
    cursor: pointer;
    position: relative;
    overflow: visible;
  }
  .side-btn:hover {
    background: #b2547f;
  }
  .side-btn.expanded {
    width: 110px;
    padding-left: 12px;
    text-align: left;
  }
  .side-btn span {
    pointer-events: none;
    user-select: none;
  }

  /* –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π */
  #profile-panel {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #fff0f6;
    box-shadow: inset 0 0 30px rgba(204,102,153,0.4);
    z-index: 20;
    padding: 20px;
    display: none;
    overflow-y: auto;
  }
  #profile-panel.open {
    display: block;
  }

  /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å */
  #profile-close {
    position: absolute;
    top: 12px; right: 12px;
    background: #cc6699;
    border: none;
    border-radius: 50%;
    width: 32px; height: 32px;
    font-weight: 700;
    color: white;
    cursor: pointer;
  }

  /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è */
  #profile-nav {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
  }
  #profile-nav button {
    background: #cc6699;
    border: none;
    border-radius: 12px;
    color: white;
    padding: 8px 16px;
    font-weight: 700;
    cursor: pointer;
  }
  #profile-nav button.active {
    background: #b2547f;
  }

  /* –ö–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ—Ñ–∏–ª—è */
  .profile-section {
    display: none;
  }
  .profile-section.active {
    display: block;
  }

  /* –ê–≤–∞—Ç–∞—Ä */
  #avatar-preview {
    width: 120px; height: 120px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 64px;
    font-weight: 900;
    color: white;
    margin-bottom: 16px;
    user-select: none;
  }
  #avatar-controls {
    margin-bottom: 24px;
  }
  #avatar-controls label {
    display: block;
    margin-bottom: 8px;
    font-weight: 700;
    color: #6a4a6a;
  }
  #avatar-text {
    width: 60px;
    font-size: 28px;
    padding: 4px 8px;
    border-radius: 6px;
    border: 2px solid #cc6699;
    text-align: center;
    text-transform: uppercase;
  }
  #avatar-bgcolor {
    width: 100px;
    height: 32px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
  }

  /* –ù–∏–∫ */
  #nickname-input {
    width: 280px;
    padding: 8px;
    font-size: 18px;
    border-radius: 8px;
    border: 2px solid #cc6699;
    margin-bottom: 12px;
  }
  #nickname-msg {
    color: #b2547f;
    font-size: 14px;
    min-height: 18px;
  }

  /* ID */
  #profile-id {
    font-weight: 700;
    font-size: 18px;
    margin-bottom: 8px;
    user-select: all;
  }
  #copy-id-btn {
    background: #cc6699;
    border: none;
    border-radius: 8px;
    color: white;
    padding: 8px 16px;
    cursor: pointer;
    font-weight: 700;
  }

  /* –î—Ä—É–∑—å—è */
  #friends-list {
    max-height: 400px;
    overflow-y: auto;
  }
  .friend-item {
    background: #ffe3f2;
    border-radius: 12px;
    display: flex;
    align-items: center;
    padding: 8px 12px;
    margin-bottom: 10px;
    gap: 12px;
  }
  .friend-avatar {
    width: 48px; height: 48px;
    border-radius: 50%;
    font-weight: 900;
    font-size: 24px;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    user-select: none;
  }
  .friend-info {
    flex-grow: 1;
  }
  .friend-name {
    font-weight: 700;
    color: #6a4a6a;
  }
  .friend-id {
    font-size: 12px;
    color: #9e729e;
    user-select: all;
  }
  .friend-buttons {
    display: flex;
    gap: 6px;
  }
  .friend-buttons button {
    background: #cc6699;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    padding: 6px 10px;
    font-weight: 700;
    font-size: 12px;
  }

  /* –í–≤–æ–¥ ID –¥—Ä—É–≥–∞ */
  #add-friend-input {
    width: 200px;
    padding: 8px;
    font-size: 16px;
    border-radius: 8px;
    border: 2px solid #cc6699;
    margin-right: 8px;
  }
  #add-friend-btn {
    background: #cc6699;
    border: none;
    border-radius: 8px;
    color: white;
    padding: 8px 14px;
    cursor: pointer;
    font-weight: 700;
  }
  #add-friend-msg {
    margin-top: 8px;
    font-size: 14px;
    min-height: 18px;
    color: #b2547f;
  }

  /* –ú–µ–±–µ–ª—å –≤ –∫–æ–º–Ω–∞—Ç–µ */
  .furniture-placed {
    position: absolute;
    width: 80px; height: 80px;
    border-radius: 10px;
    background-color: #cc6699;
    color: white;
    font-weight: 700;
    font-size: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    user-select: none;
    cursor: grab;
    box-shadow: 0 4px 6px rgba(204,102,153,0.6);
    transition: box-shadow 0.2s ease;
  }
  .furniture-placed.dragging {
    opacity: 0.7;
    box-shadow: 0 8px 16px rgba(204,102,153,0.9);
    cursor: grabbing;
  }

  /* –û–±–æ–∏ –∏ –ø–æ–ª (–ø—Ä–æ—Å—Ç–∞—è –∏–º–∏—Ç–∞—Ü–∏—è) */
  #wallpaper {
    position: absolute;
    top: 0; left: 0; right: 0; height: 40%;
    background-repeat: repeat;
    opacity: 0.3;
    pointer-events: none;
  }
  #floor {
    position: absolute;
    bottom: 0; left: 0; right: 0; height: 60%;
    background-repeat: repeat;
    opacity: 0.3;
    pointer-events: none;
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
  .fade-in {
    animation: fadein 0.4s ease forwards;
  }
  @keyframes fadein {
    from {opacity: 0;}
    to {opacity: 1;}
  }
</style>
</head>
<body>
<div id="app">
  <div id="apartment">
    <div id="room-name">–ö–æ–º–Ω–∞—Ç–∞ 1</div>
    <div id="room-content">
      <div id="wallpaper"></div>
      <div id="floor"></div>
      <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –º–µ–±–µ–ª—å -->
    </div>
    <div id="room-controls">
      <button id="prev-room-btn">&lt; –ù–∞–∑–∞–¥</button>
      <button id="next-room-btn">–í–ø–µ—Ä—ë–¥ &gt;</button>
      <button id="add-room-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    </div>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å –º–µ–±–µ–ª–∏ -->
  <div id="furniture-panel">
    <button id="furniture-close">√ó</button>
    <h3>–ú–µ–±–µ–ª—å</h3>
    <div id="furniture-list"></div>
  </div>

  <!-- –í–µ—Ä—Ö–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ -->
  <div id="top-buttons">
    <button class="side-btn" id="profile-btn"><span>–ü</span></button>
    <button class="side-btn" id="furniture-btn"><span>–ú</span></button>
  </div>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
  <div id="profile-panel">
    <button id="profile-close">√ó</button>
    <div id="profile-nav">
      <button data-section="profile" class="active">–ü—Ä–æ—Ñ–∏–ª—å</button>
      <button data-section="friends">–î—Ä—É–∑—å—è</button>
      <button data-section="id">ID</button>
    </div>

    <div id="profile-content">
      <section id="profile-section-profile" class="profile-section active">
        <div id="avatar-preview" title="–ê–≤–∞—Ç–∞—Ä"></div>
        <div id="avatar-controls">
          <label for="avatar-text">–¢–µ–∫—Å—Ç –∞–≤–∞—Ç–∞—Ä–∞ (–º–∞–∫—Å 2 —Å–∏–º–≤–æ–ª–∞):</label>
          <input type="text" id="avatar-text" maxlength="2" />
          <label for="avatar-bgcolor">–¶–≤–µ—Ç —Ñ–æ–Ω–∞:</label>
          <input type="color" id="avatar-bgcolor" value="#cc6699" />
          <button id="save-avatar-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</button>
          <div id="avatar-msg" style="color:#b2547f; margin-top:8px; min-height:18px;"></div>
        </div>

        <div>
          <label for="nickname-input">–ù–∏–∫–Ω–µ–π–º (–º–∞–∫—Å 25 —Å–∏–º–≤–æ–ª–æ–≤):</label><br/>
          <input type="text" id="nickname-input" maxlength="25" />
          <button id="save-nickname-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏–∫</button>
          <div id="nickname-msg"></div>
        </div>
      </section>

      <section id="profile-section-friends" class="profile-section">
        <div style="margin-bottom:12px;">
          <input type="text" id="add-friend-input" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞" />
          <button id="add-friend-btn">–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</button>
          <div id="add-friend-msg"></div>
        </div>
        <div id="friends-list"></div>
      </section>

      <section id="profile-section-id" class="profile-section">
        <div>–í–∞—à ID –ø—Ä–æ—Ñ–∏–ª—è:</div>
        <div id="profile-id" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"></div>
        <button id="copy-id-btn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID</button>
      </section>
    </div>
  </div>
</div>

<script>
(() => {
  // --- –£—Ç–∏–ª–∏—Ç—ã ---
  function $(id) { return document.getElementById(id); }
  function clamp(num, min, max) { return Math.min(Math.max(num, min), max); }
  function now() { return Date.now(); }

  // --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID ---
  function generateID(length = 6) {
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let id = '';
    for (let i = 0; i < length; i++) {
      id += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return id;
  }

  // --- –•—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è ---
  function loadProfile() {
    let prof = localStorage.getItem('profile');
    if (prof) {
      try {
        return JSON.parse(prof);
      } catch {
        return createNewProfile();
      }
    } else {
      return createNewProfile();
    }
  }
  function saveProfile() {
    localStorage.setItem('profile', JSON.stringify(profile));
  }
  function createNewProfile() {
    return {
      id: generateID(6),
      nickname: '–ò–≥—Ä–æ–∫',
      avatar: { text: 'üòÄ', bgColor: '#cc6699' },
      lastNameChange: 0,
      lastAvatarChange: 0,
      friends: [],
      apartmentCode: '',
      rooms: [
        { name: '–ö–æ–º–Ω–∞—Ç–∞ 1', wallpaper: '‚óç', wallpaperColor: '#ffccd9', floor: '||||||||', floorColor: '#bb9999', furniture: [] }
      ],
      currentRoomIndex: 0
    };
  }

  // --- –ö–æ–¥—ã –∫–≤–∞—Ä—Ç–∏—Ä—ã (—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è) ---
  // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —Ö—Ä–∞–Ω—é –≤ JSON —Å—Ç—Ä–æ–∫–µ
  function serializeApartment(rooms) {
    return JSON.stringify(rooms);
  }
  function deserializeApartment(code) {
    try {
      const rooms = JSON.parse(code);
      if (Array.isArray(rooms)) return rooms;
      else return null;
    } catch {
      return null;
    }
  }

  // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
  let profile = loadProfile();

  // --- DOM —ç–ª–µ–º–µ–Ω—Ç—ã ---
  const profilePanel = $('profile-panel');
  const profileBtn = $('profile-btn');
  const furnitureBtn = $('furniture-btn');
  const furniturePanel = $('furniture-panel');
  const furnitureClose = $('furniture-close');
  const profileClose = $('profile-close');
  const topButtons = $('top-buttons');
  const roomName = $('room-name');
  const roomContent = $('room-content');
  const wallpaperDiv = $('wallpaper');
  const floorDiv = $('floor');
  const roomControls = $('room-controls');
  const prevRoomBtn = $('prev-room-btn');
  const nextRoomBtn = $('next-room-btn');
  const addRoomBtn = $('add-room-btn');

  // --- –ü—Ä–æ—Ñ–∏–ª—å: –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∏ —Å–µ–∫—Ü–∏–∏ ---
  const profileNavBtns = [...document.querySelectorAll('#profile-nav button')];
  const profileSections = [...document.querySelectorAll('.profile-section')];

  // --- –ü—Ä–æ—Ñ–∏–ª—å: –∞–≤–∞—Ç–∞—Ä –∏ –Ω–∏–∫ ---
  const avatarPreview = $('avatar-preview');
  const avatarTextInput = $('avatar-text');
  const avatarBgInput = $('avatar-bgcolor');
  const saveAvatarBtn = $('save-avatar-btn');
  const avatarMsg = $('avatar-msg');

  const nicknameInput = $('nickname-input');
  const saveNicknameBtn = $('save-nickname-btn');
  const nicknameMsg = $('nickname-msg');

  // --- –ü—Ä–æ—Ñ–∏–ª—å: ID ---
  const profileIdDiv = $('profile-id');
  const copyIdBtn = $('copy-id-btn');

  // --- –î—Ä—É–∑—å—è ---
  const addFriendInput = $('add-friend-input');
  const addFriendBtn = $('add-friend-btn');
  const addFriendMsg = $('add-friend-msg');
  const friendsListDiv = $('friends-list');

  // --- –ú–µ–±–µ–ª—å ---
  const furnitureListDiv = $('furniture-list');

  // --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –º–µ–±–µ–ª–∏ ---
  const furnitureCatalog = [
    { id: 'chair', name: '–ö—Ä–µ—Å–ª–æ', symbol: 'ü™ë' },
    { id: 'sofa', name: '–î–∏–≤–∞–Ω', symbol: 'üõãÔ∏è' },
    { id: 'table', name: '–°—Ç–æ–ª', symbol: 'üõèÔ∏è' },
    { id: 'lamp', name: '–õ–∞–º–ø–∞', symbol: 'üí°' },
    { id: 'rug', name: '–ö–æ–≤—ë—Ä', symbol: 'üß∂' }
  ];

  // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ---

  // –û–±–Ω–æ–≤–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
  function updateAvatarPreview() {
    avatarPreview.textContent = profile.avatar.text || '';
    avatarPreview.style.backgroundColor = profile.avatar.bgColor || '#cc6699';
    avatarTextInput.value = profile.avatar.text || '';
    avatarBgInput.value = profile.avatar.bgColor || '#cc6699';
  }

  // –û–±–Ω–æ–≤–∏—Ç—å –Ω–∏–∫
  function updateNicknameInput() {
    nicknameInput.value = profile.nickname || '–ò–≥—Ä–æ–∫';
    nicknameMsg.textContent = '';
  }

  // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å ID
  function updateProfileID() {
    profileIdDiv.textContent = profile.id;
  }

  // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
  function toggleProfile(open) {
    if (open) {
      profilePanel.classList.add('open');
      profileBtn.classList.add('expanded');
      furnitureBtn.classList.remove('expanded');
      furniturePanel.classList.remove('open');
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
      switchProfileSection('profile');
    } else {
      profilePanel.classList.remove('open');
      profileBtn.classList.remove('expanded');
    }
  }

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π –ø—Ä–æ—Ñ–∏–ª—è
  function switchProfileSection(section) {
    profileSections.forEach(s => s.classList.remove('active'));
    profileNavBtns.forEach(b => b.classList.remove('active'));

    let targetSection = null;
    for (const s of profileSections) {
      if (s.id === `profile-section-${section}`) {
        s.classList.add('active');
        targetSection = s;
        break;
      }
    }
    for (const b of profileNavBtns) {
      if (b.dataset.section === section) {
        b.classList.add('active');
      }
    }
  }

  // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π
  function updateFriendsList() {
    friendsListDiv.innerHTML = '';
    if (!profile.friends.length) {
      friendsListDiv.textContent = '–£ –≤–∞—Å –Ω–µ—Ç –¥—Ä—É–∑–µ–π.';
      return;
    }
    profile.friends.forEach(friend => {
      const div = document.createElement('div');
      div.className = 'friend-item';

      const avatar = document.createElement('div');
      avatar.className = 'friend-avatar';
      avatar.style.backgroundColor = friend.avatar.bgColor || '#cc6699';
      avatar.textContent = friend.avatar.text || 'üôÇ';

      const info = document.createElement('div');
      info.className = 'friend-info';

      const name = document.createElement('div');
      name.className = 'friend-name';
      name.textContent = friend.nickname || '–î—Ä—É–≥';

      const idDiv = document.createElement('div');
      idDiv.className = 'friend-id';
      idDiv.textContent = friend.id;

      info.appendChild(name);
      info.appendChild(idDiv);

      const buttonsDiv = document.createElement('div');
      buttonsDiv.className = 'friend-buttons';

      const enterBtn = document.createElement('button');
      enterBtn.textContent = '–í–æ–π—Ç–∏';
      enterBtn.title = `–í–æ–π—Ç–∏ –≤ –∫–≤–∞—Ä—Ç–∏—Ä—É ${friend.nickname}`;
      enterBtn.onclick = () => {
        if (friend.apartmentCode) {
          loadApartmentFromCode(friend.apartmentCode);
          toggleProfile(false);
        } else {
          alert('–î—Ä—É–≥ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª –∫–≤–∞—Ä—Ç–∏—Ä—É.');
        }
      };

      const copyBtn = document.createElement('button');
      copyBtn.textContent = 'ID';
      copyBtn.title = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID';
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(friend.id);
        alert(`ID ${friend.id} —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω`);
      };

      const delBtn = document.createElement('button');
      delBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
      delBtn.title = '–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π';
      delBtn.onclick = () => {
        if (confirm(`–£–¥–∞–ª–∏—Ç—å ${friend.nickname} –∏–∑ –¥—Ä—É–∑–µ–π?`)) {
          profile.friends = profile.friends.filter(f => f.id !== friend.id);
          saveProfile();
          updateFriendsList();
        }
      };

      buttonsDiv.appendChild(enterBtn);
      buttonsDiv.appendChild(copyBtn);
      buttonsDiv.appendChild(delBtn);

      div.appendChild(avatar);
      div.appendChild(info);
      div.appendChild(buttonsDiv);

      friendsListDiv.appendChild(div);
    });
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∞ –ø–æ ID
  function addFriendByID(id) {
    if (!id || id.length < 3) {
      addFriendMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID.';
      return;
    }
    if (id === profile.id) {
      addFriendMsg.textContent = '–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è.';
      return;
    }
    if (profile.friends.find(f => f.id === id)) {
      addFriendMsg.textContent = '–≠—Ç–æ—Ç –¥—Ä—É–≥ —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ.';
      return;
    }
    // –ü–æ—Å–∫–æ–ª—å–∫—É –Ω–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞, —Å–∏–º—É–ª–∏—Ä—É–µ–º "–∑–∞–ø—Ä–æ—Å" ‚Äî 
    // –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–¥–∏–º –∑–∞–≥–ª—É—à–∫—É –¥—Ä—É–≥–∞ —Å —Ä–∞–Ω–¥–æ–º–Ω—ã–º –Ω–∏–∫–æ–º –∏ –ø—É—Å—Ç–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–æ–π
    const fakeFriend = {
      id: id,
      nickname: '–î—Ä—É–≥' + id.slice(0, 3),
      avatar: { text: 'üôÇ', bgColor: '#cc6699' },
      apartmentCode: ''
    };

    if (confirm(`–î–æ–±–∞–≤–∏—Ç—å ${fakeFriend.nickname} –≤ –¥—Ä—É–∑—å—è?`)) {
      profile.friends.push(fakeFriend);
      saveProfile();
      updateFriendsList();
      addFriendMsg.textContent = '–î—Ä—É–≥ –¥–æ–±–∞–≤–ª–µ–Ω.';
      addFriendInput.value = '';
    } else {
      addFriendMsg.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.';
    }
  }

  // --- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–≤–∞—Ä—Ç–∏—Ä—ã ---

  function updateRoomName() {
    roomName.textContent = profile.rooms[profile.currentRoomIndex].name;
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–±–æ–µ–≤ –∏ –ø–æ–ª–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
  function updateRoomWallpaperAndFloor() {
    const room = profile.rooms[profile.currentRoomIndex];
    wallpaperDiv.style.backgroundImage = `repeating-linear-gradient(45deg, ${room.wallpaperColor}, ${room.wallpaperColor} 10px, transparent 10px, transparent 20px)`;
    floorDiv.style.backgroundImage = `repeating-linear-gradient(0deg, ${room.floorColor}, ${room.floorColor} 12px, transparent 12px, transparent 24px)`;
  }

  // –£–¥–∞–ª–∏—Ç—å –º–µ–±–µ–ª—å —Å –∫–æ–º–Ω–∞—Ç—ã (—É–¥–∞–ª–∏—Ç—å –∏–∑ DOM –∏ –º–∞—Å—Å–∏–≤–∞)
  function removeFurnitureById(fid) {
    let room = profile.rooms[profile.currentRoomIndex];
    room.furniture = room.furniture.filter(f => f.instanceId !== fid);
    saveProfile();
    renderFurnitureInRoom();
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID –¥–ª—è –º–µ–±–µ–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ
  function generateFurnitureInstanceId() {
    return 'furn_' + Math.random().toString(36).substring(2, 9);
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–µ–±–µ–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ
  function renderFurnitureInRoom() {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    [...roomContent.querySelectorAll('.furniture-placed')].forEach(el => el.remove());

    const room = profile.rooms[profile.currentRoomIndex];

    room.furniture.forEach(item => {
      const div = document.createElement('div');
      div.className = 'furniture-placed';
      div.textContent = item.symbol;
      div.style.left = item.x + 'px';
      div.style.top = item.y + 'px';
      div.style.transform = `rotate(${item.rotation}deg)`;
      div.setAttribute('data-instance-id', item.instanceId);
      roomContent.appendChild(div);

      // –î—Ä–∞–≥-–Ω-–¥—Ä–æ–ø –º–µ–±–µ–ª–∏
      div.onmousedown = (e) => {
        e.preventDefault();
        let startX = e.clientX;
        let startY = e.clientY;
        let origX = item.x;
        let origY = item.y;
        div.classList.add('dragging');

        function onMouseMove(ev) {
          const dx = ev.clientX - startX;
          const dy = ev.clientY - startY;
          item.x = clamp(origX + dx, 0, roomContent.clientWidth - 80);
          item.y = clamp(origY + dy, 0, roomContent.clientHeight - 80);
          div.style.left = item.x + 'px';
          div.style.top = item.y + 'px';
        }
        function onMouseUp() {
          div.classList.remove('dragging');
          saveProfile();
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        }
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      };

      // –ö–ª–∏–∫ –ø–æ –º–µ–±–µ–ª–∏ ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–¥–∞–ª–∏—Ç—å
      div.ondblclick = () => {
        if (confirm('–£–¥–∞–ª–∏—Ç—å –º–µ–±–µ–ª—å?')) {
          removeFurnitureById(item.instanceId);
        }
      };
    });
  }

  // –î–æ–±–∞–≤–∏—Ç—å –º–µ–±–µ–ª—å –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ –≤ –∫–æ–º–Ω–∞—Ç—É
  function addFurnitureToRoom(furn) {
    const room = profile.rooms[profile.currentRoomIndex];
    const newItem = {
      instanceId: generateFurnitureInstanceId(),
      id: furn.id,
      symbol: furn.symbol,
      x: 50,
      y: 50,
      rotation: 0
    };
    room.furniture.push(newItem);
    saveProfile();
    renderFurnitureInRoom();
  }

  // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–∞–º–∏ ---
  function changeRoom(offset) {
    let newIndex = profile.currentRoomIndex + offset;
    if (newIndex < 0) newIndex = profile.rooms.length - 1;
    if (newIndex >= profile.rooms.length) newIndex = 0;
    profile.currentRoomIndex = newIndex;
    updateRoomName();
    updateRoomWallpaperAndFloor();
    renderFurnitureInRoom();
  }

  function addNewRoom() {
    let newRoomNum = profile.rooms.length + 1;
    profile.rooms.push({
      name: '–ö–æ–º–Ω–∞—Ç–∞ ' + newRoomNum,
      wallpaper: '‚óç',
      wallpaperColor: '#ffccd9',
      floor: '||||||||',
      floorColor: '#bb9999',
      furniture: []
    });
    profile.currentRoomIndex = profile.rooms.length - 1;
    saveProfile();
    updateRoomName();
    updateRoomWallpaperAndFloor();
    renderFurnitureInRoom();
  }

  // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–±–µ–ª–∏ –≤ –ø–∞–Ω–µ–ª–∏ ---
  function initFurniturePanel() {
    furnitureListDiv.innerHTML = '';
    furnitureCatalog.forEach(furn => {
      const div = document.createElement('div');
      div.className = 'furniture-item';
      div.title = furn.name;
      div.textContent = furn.symbol;
      div.draggable = true;

      div.ondragstart = e => {
        e.dataTransfer.setData('text/plain', furn.id);
      };
      furnitureListDiv.appendChild(div);
    });
  }

  // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ drag-n-drop –º–µ–±–µ–ª–∏ –∏–∑ –ø–∞–Ω–µ–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç—É ---
  roomContent.ondragover = e => {
    e.preventDefault();
  };
  roomContent.ondrop = e => {
    e.preventDefault();
    const id = e.dataTransfer.getData('text/plain');
    const furn = furnitureCatalog.find(f => f.id === id);
    if (furn) {
      addFurnitureToRoom(furn);
      // –ü–æ–º–µ—Å—Ç–∏—Ç—å –º–µ–±–µ–ª—å –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–º, –≥–¥–µ –æ—Ç–ø—É—Å—Ç–∏–ª–∏
      const room = profile.rooms[profile.currentRoomIndex];
      let rect = roomContent.getBoundingClientRect();
      let x = e.clientX - rect.left - 40;
      let y = e.clientY - rect.top - 40;
      let added = room.furniture[room.furniture.length - 1];
      added.x = clamp(x, 0, roomContent.clientWidth - 80);
      added.y = clamp(y, 0, roomContent.clientHeight - 80);
      saveProfile();
      renderFurnitureInRoom();
    }
  };

  // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø—Ä–æ—Ñ–∏–ª—è ---
  updateAvatarPreview();
  updateNicknameInput();
  updateProfileID();
  updateRoomName();
  updateRoomWallpaperAndFloor();
  renderFurnitureInRoom();
  updateFriendsList();
  initFurniturePanel();

  // --- –°–æ–±—ã—Ç–∏—è ---

  // –ö–Ω–æ–ø–∫–∏ —Å–≤–µ—Ä—Ö—É
  profileBtn.onmouseenter = () => profileBtn.classList.add('expanded');
  profileBtn.onmouseleave = () => { if (!profilePanel.classList.contains('open')) profileBtn.classList.remove('expanded'); };
  furnitureBtn.onmouseenter = () => furnitureBtn.classList.add('expanded');
  furnitureBtn.onmouseleave = () => { if (!furniturePanel.classList.contains('open')) furnitureBtn.classList.remove('expanded'); };

  profileBtn.onclick = () => toggleProfile(!profilePanel.classList.contains('open'));
  profileClose.onclick = () => toggleProfile(false);

  furnitureBtn.onclick = () => {
    let isOpen = furniturePanel.classList.toggle('open');
    if (isOpen) {
      furnitureBtn.classList.add('expanded');
      toggleProfile(false);
    } else {
      furnitureBtn.classList.remove('expanded');
    }
  };
  furnitureClose.onclick = () => {
    furniturePanel.classList.remove('open');
    furnitureBtn.classList.remove('expanded');
  };

  // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è
  profileNavBtns.forEach(btn => {
    btn.onclick = () => {
      switchProfileSection(btn.dataset.section);
    };
  });

  // –ê–≤–∞—Ç–∞—Ä –∏ –Ω–∏–∫–Ω–µ–π–º
  saveAvatarBtn.onclick = () => {
    let nowTime = now();
    if (nowTime - profile.lastAvatarChange < 10 * 60 * 1000) {
      avatarMsg.textContent = '–ê–≤–∞—Ç–∞—Ä –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Ä–∞–∑ –≤ 10 –º–∏–Ω—É—Ç.';
      return;
    }
    let text = avatarTextInput.value.trim();
    if (text.length > 2) text = text.slice(0, 2);
    profile.avatar.text = text || 'üôÇ';
    profile.avatar.bgColor = avatarBgInput.value;
    profile.lastAvatarChange = nowTime;
    saveProfile();
    updateAvatarPreview();
    updateFriendsList();
    avatarMsg.textContent = '–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω.';
  };

  saveNicknameBtn.onclick = () => {
    let nowTime = now();
    if (nowTime - profile.lastNameChange < 60 * 60 * 1000) {
      nicknameMsg.textContent = '–ù–∏–∫ –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Ä–∞–∑ –≤ —á–∞—Å.';
      return;
    }
    let newNick = nicknameInput.value.trim();
    if (newNick.length === 0) {
      nicknameMsg.textContent = '–ù–∏–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.';
      return;
    }
    if (newNick.length > 25) {
      nicknameMsg.textContent = '–ù–∏–∫ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π.';
      return;
    }
    profile.nickname = newNick;
    profile.lastNameChange = nowTime;
    saveProfile();
    nicknameMsg.textContent = '–ù–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.';
    updateFriendsList();
  };

  // ID –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
  copyIdBtn.onclick = () => {
    navigator.clipboard.writeText(profile.id);
    alert('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.');
  };
  profileIdDiv.onclick = () => {
    navigator.clipboard.writeText(profile.id);
    alert('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.');
  };

  // –î—Ä—É–∑—å—è
  addFriendBtn.onclick = () => {
    addFriendMsg.textContent = '';
    addFriendByID(addFriendInput.value.trim());
  };

  // –ö–æ–º–Ω–∞—Ç—ã
  prevRoomBtn.onclick = () => {
    changeRoom(-1);
  };
  nextRoomBtn.onclick = () => {
    changeRoom(1);
  };
  addRoomBtn.onclick = () => {
    addNewRoom();
  };

  // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã –¥—Ä—É–≥–∞ ---
  function loadApartmentFromCode(code) {
    let rooms = deserializeApartment(code);
    if (!rooms) {
      alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∫–≤–∞—Ä—Ç–∏—Ä—ã.');
      return;
    }
    profile.rooms = rooms;
    profile.currentRoomIndex = 0;
    saveProfile();
    updateRoomName();
    updateRoomWallpaperAndFloor();
    renderFurnitureInRoom();
  }

  // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã ---
  // –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω—É–∂–Ω–æ –≤ UI –¥–æ–±–∞–≤–∏—Ç—å)
  function saveApartment() {
    profile.apartmentCode = serializeApartment(profile.rooms);
    saveProfile();
    alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –î—Ä—É–≥ —Å–º–æ–∂–µ—Ç –∏—Ö —É–≤–∏–¥–µ—Ç—å –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã.');
  }

  // –î–æ–±–∞–≤–∏–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–≤–∞—Ä—Ç–∏—Ä—ã
  const saveBtn = document.createElement('button');
  saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
  saveBtn.style.position = 'absolute';
  saveBtn.style.top = '12px';
  saveBtn.style.right = '12px';
  saveBtn.style.zIndex = 15;
  saveBtn.style.padding = '8px 14px';
  saveBtn.style.background = '#cc6699';
  saveBtn.style.border = 'none';
  saveBtn.style.color = 'white';
  saveBtn.style.borderRadius = '8px';
  saveBtn.style.fontWeight = '700';
  saveBtn.style.cursor = 'pointer';
  saveBtn.onclick = saveApartment;
  $('apartment').appendChild(saveBtn);

  // --- –ö–Ω–æ–ø–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ ---
  function setupSideButton(btn, fullText) {
    btn.onmouseenter = () => {
      btn.classList.add('expanded');
      btn.innerHTML = fullText;
    };
    btn.onmouseleave = () => {
      if ((btn === profileBtn && profilePanel.classList.contains('open')) ||
          (btn === furnitureBtn && furniturePanel.classList.contains('open'))) {
        return; // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–º
      }
      btn.classList.remove('expanded');
      btn.innerHTML = btn.id === 'profile-btn' ? '–ü' : '–ú';
    };
  }
  setupSideButton(profileBtn, '–ü—Ä–æ—Ñ–∏–ª—å');
  setupSideButton(furnitureBtn, '–ú–µ–±–µ–ª—å');

})();
</script>
</body>
</html>
