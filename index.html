<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Toca Boca World Remix — Часть 1</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin:0; padding:0; height:100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f5f5;
    color: #333;
    user-select: none;
    overflow: hidden;
  }
  #app {
    position: relative;
    width: 100vw;
    height: 100vh;
    background: #e2e2e2; /* базовый фон */
    display: flex;
    flex-direction: column;
  }

  /* Верхняя панель — навигация и комнаты */
  header {
    height: 50px;
    background: #d6cdc2;
    display: flex;
    align-items: center;
    padding: 0 15px;
    user-select: none;
    box-shadow: inset 0 -2px 4px rgb(0 0 0 / 0.1);
  }
  #room-name {
    flex-grow: 1;
    font-weight: 600;
    font-size: 1.2rem;
    user-select: text;
  }
  button {
    background: #b3a394;
    border: none;
    color: #fff;
    font-weight: 600;
    padding: 8px 14px;
    margin-left: 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  button:disabled {
    background: #aaa59a;
    cursor: default;
  }
  button:hover:not(:disabled) {
    background: #8f7e6e;
  }

  /* Основной экран — комнаты */
  #rooms-container {
    flex-grow: 1;
    position: relative;
    background: #c3c3c3;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }
  .room {
    position: relative;
    width: 90%;
    height: 90%;
    background-color: white;
    border-radius: 18px;
    box-shadow:
      0 8px 15px rgb(0 0 0 / 0.1),
      inset 0 0 50px rgb(255 255 255 / 0.8);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  #room-title {
    height: 40px;
    background: #b6a68b;
    color: #fff;
    font-weight: 700;
    font-size: 1.1rem;
    line-height: 40px;
    padding-left: 20px;
    user-select: none;
    box-shadow: inset 0 -3px 6px rgb(0 0 0 / 0.15);
  }
  #room-furniture {
    flex-grow: 1;
    background: #f2efe8;
    position: relative;
    padding: 20px;
    overflow-y: auto;
    border-radius: 0 0 18px 18px;
  }
  #room-furniture > div {
    font-style: italic;
    color: #888;
  }

  /* Панели Мебели и Профиля */
  #furniture-panel, #profile-panel {
    position: fixed;
    top: 50px;
    bottom: 0;
    width: 320px;
    background: #f7f1e8;
    box-shadow: 2px 0 8px rgb(0 0 0 / 0.2);
    overflow-y: auto;
    padding: 15px;
    transition: transform 0.35s ease;
    z-index: 1000;
  }
  #furniture-panel {
    left: 0;
    transform: translateX(-100%);
  }
  #furniture-panel.visible {
    transform: translateX(0);
  }
  #profile-panel {
    right: 0;
    width: 400px;
    transform: translateX(100%);
  }
  #profile-panel.visible {
    transform: translateX(0);
  }

  /* Заголовки панелей */
  #furniture-panel > h2,
  #profile-panel > h2 {
    margin-top: 0;
    font-weight: 700;
    font-size: 1.3rem;
    border-bottom: 2px solid #a89a7d;
    padding-bottom: 10px;
    color: #6b5e44;
  }
  /* Кнопки закрытия */
  .close-btn {
    background: transparent;
    border: none;
    font-size: 22px;
    position: absolute;
    top: 12px;
    right: 12px;
    cursor: pointer;
    color: #6b5e44;
  }
  .close-btn:hover {
    color: #3e3b2d;
  }

  /* Кнопки М и П в верхнем правом углу */
  #top-right-buttons {
    position: fixed;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 8px;
    z-index: 1100;
  }
  #top-right-buttons button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-weight: 700;
    font-size: 1.2rem;
    padding: 0;
    background: #b3a394;
    color: #fff;
    box-shadow: 0 2px 5px rgb(0 0 0 / 0.2);
  }
  #top-right-buttons button:hover {
    background: #8f7e6e;
  }
  #top-right-buttons button[title]:hover::after {
    content: attr(title);
    position: absolute;
    top: 48px;
    right: 0;
    background: #6b5e44;
    color: white;
    padding: 3px 8px;
    border-radius: 6px;
    font-size: 0.8rem;
    white-space: nowrap;
    user-select: none;
  }

  /* Стили для списка мебели (пока пустой) */
  #furniture-list {
    margin-top: 10px;
    font-style: italic;
    color: #777;
    user-select: none;
  }

  /* Профиль */
  #profile-content {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  #avatar-preview {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    font-size: 42px;
    font-weight: 700;
    color: white;
    background: #a28e6f;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    margin-bottom: 10px;
    text-transform: uppercase;
  }
  input[type="text"], input[type="color"] {
    width: 100%;
    font-size: 1.1rem;
    padding: 6px 10px;
    border-radius: 8px;
    border: 1.5px solid #b3a394;
    outline-offset: 2px;
    outline-color: #b3a394;
  }
  label {
    font-weight: 600;
    color: #6b5e44;
    user-select: none;
  }

  /* Селекторы кнопок в header */
  #header-buttons {
    display: flex;
    gap: 8px;
  }
</style>
</head>
<body>
<div id="app">
  <header>
    <div id="room-name">Комната 1</div>
    <div id="header-buttons">
      <button id="prev-room" title="Предыдущая комната" disabled>←</button>
      <button id="next-room" title="Следующая комната">→</button>
      <button id="add-room" title="Добавить новую комнату">➕</button>
    </div>
  </header>

  <main id="rooms-container" aria-label="Контейнер комнат">
    <!-- Комнаты будут тут -->
  </main>

  <!-- Панель мебели -->
  <aside id="furniture-panel" aria-label="Панель мебели" role="region" aria-hidden="true">
    <button class="close-btn" id="close-furniture" aria-label="Закрыть панель мебели">✕</button>
    <h2>Мебель</h2>
    <div id="furniture-list">Панель мебели пока пустая</div>
  </aside>

  <!-- Панель профиля -->
  <aside id="profile-panel" aria-label="Панель профиля" role="region" aria-hidden="true">
    <button class="close-btn" id="close-profile" aria-label="Закрыть панель профиля">✕</button>
    <h2>Профиль</h2>
    <div id="profile-content">
      <div id="avatar-preview" aria-label="Аватар пользователя">А</div>
      <label for="profile-nickname">Никнейм (до 25 символов):</label>
      <input type="text" id="profile-nickname" maxlength="25" autocomplete="off" />
      <label for="profile-avatar-text">Текст на аватарке (до 2 символов):</label>
      <input type="text" id="profile-avatar-text" maxlength="2" autocomplete="off" />
      <label for="profile-avatar-bgcolor">Цвет фона аватарки:</label>
      <input type="color" id="profile-avatar-bgcolor" value="#a28e6f" />
    </div>
  </aside>

  <!-- Верхние кнопки М и П -->
  <div id="top-right-buttons" aria-label="Кнопки меню">
    <button id="btn-furniture" title="Мебель (M)" aria-haspopup="true" aria-controls="furniture-panel">М</button>
    <button id="btn-profile" title="Профиль (P)" aria-haspopup="true" aria-controls="profile-panel">П</button>
  </div>
</div>

<script>
  // --- Данные комнат ---
  const rooms = [
    {
      name: "Кухня",
      wallpaper: "#ffffff",
      wallpaperPattern: "■■■■■■",
      floorColor: "#cccccc",
      floorPattern: "||||||",
      furniture: []
    },
    {
      name: "Спальная",
      wallpaper: "#ffffff",
      wallpaperPattern: "■■■■■■",
      floorColor: "#cccccc",
      floorPattern: "||||||",
      furniture: []
    },
    {
      name: "Ванная",
      wallpaper: "#ffffff",
      wallpaperPattern: "■■■■■■",
      floorColor: "#cccccc",
      floorPattern: "||||||",
      furniture: []
    }
  ];
  let currentRoomIndex = 0;

  // --- Профиль пользователя (заготовка) ---
  const profile = {
    id: generateRandomID(),
    nickname: "",
    avatarText: "А",
    avatarBgColor: "#a28e6f"
  };

  // --- DOM элементы ---
  const roomsContainer = document.getElementById("rooms-container");
  const roomNameElem = document.getElementById("room-name");

  const prevRoomBtn = document.getElementById("prev-room");
  const nextRoomBtn = document.getElementById("next-room");
  const addRoomBtn = document.getElementById("add-room");

  const btnFurniture = document.getElementById("btn-furniture");
  const btnProfile = document.getElementById("btn-profile");

  const furniturePanel = document.getElementById("furniture-panel");
  const closeFurnitureBtn = document.getElementById("close-furniture");

  const profilePanel = document.getElementById("profile-panel");
  const profileNicknameInput = document.getElementById("profile-nickname");
  const profileAvatarTextInput = document.getElementById("profile-avatar-text");
  const profileAvatarBgColorInput = document.getElementById("profile-avatar-bgcolor");
  const avatarPreview = document.getElementById("avatar-preview");
  const closeProfileBtn = document.getElementById("close-profile");

  // === Функции ===

  // Генерация случайного ID (6 символов, буквы и цифры)
  function generateRandomID() {
    const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
    let id = "";
    for (let i = 0; i < 6; i++) {
      id += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return id;
  }

  // Обновить отображение аватарки в профиле
  function updateAvatarPreview() {
    let text = profileAvatarTextInput.value.trim();
    if (text.length === 0) text = "А";
    avatarPreview.textContent = text;
    avatarPreview.style.backgroundColor = profileAvatarBgColorInput.value;
  }

  // Отрисовать текущую комнату
  function renderCurrentRoom() {
    roomsContainer.innerHTML = ""; // очистить контейнер

    const room = rooms[currentRoomIndex];

    // Создаем див комнаты
    const roomDiv = document.createElement("div");
    roomDiv.classList.add("room");
    roomDiv.setAttribute("aria-label", "Комната " + room.name);

    // Добавляем фон обоев и пола (пока просто цвет стены и пола)
    roomDiv.style.backgroundColor = room.wallpaper;

    // Название комнаты
    const roomTitle = document.createElement("div");
    roomTitle.id = "room-title";
    roomTitle.textContent = room.name;
    roomDiv.appendChild(roomTitle);

    // Мебель в комнате (пока пусто)
    const furnitureContainer = document.createElement("div");
    furnitureContainer.id = "room-furniture";

    const emptyMsg = document.createElement("div");
    emptyMsg.textContent = "В комнате пока нет мебели.";
    emptyMsg.style.color = "#7a7a7a";
    emptyMsg.style.fontStyle = "italic";
    furnitureContainer.appendChild(emptyMsg);

    roomDiv.appendChild(furnitureContainer);

    roomsContainer.appendChild(roomDiv);

    // Обновить название в верхней панели
    roomNameElem.textContent = room.name;

    updateRoomButtonsState();
  }

  // Обновить доступность кнопок переключения комнат
  function updateRoomButtonsState() {
    prevRoomBtn.disabled = currentRoomIndex === 0;
    nextRoomBtn.disabled = currentRoomIndex === rooms.length - 1;
  }

  // Переключение комнаты
  function changeRoom(direction) {
    if (direction === "next" && currentRoomIndex < rooms.length - 1) {
      currentRoomIndex++;
    } else if (direction === "prev" && currentRoomIndex > 0) {
      currentRoomIndex--;
    }
    renderCurrentRoom();
  }

  // Добавление новой комнаты
  function addRoom() {
    const defaultName = "Новая комната";
    const newRoom = {
      name: defaultName,
      wallpaper: "#ffffff",
      wallpaperPattern: "■■■■■■",
      floorColor: "#cccccc",
      floorPattern: "||||||",
      furniture: []
    };
    rooms.push(newRoom);
    currentRoomIndex = rooms.length - 1;
    renderCurrentRoom();
  }

  // Показать / скрыть мебель
  function toggleFurniturePanel() {
    if (furniturePanel.classList.contains("visible")) {
      furniturePanel.classList.remove("visible");
      furniturePanel.setAttribute("aria-hidden", "true");
    } else {
      furniturePanel.classList.add("visible");
      furniturePanel.setAttribute("aria-hidden", "false");
      // Закроем профиль если открыт
      profilePanel.classList.remove("visible");
      profilePanel.setAttribute("aria-hidden", "true");
    }
  }

  // Показать / скрыть профиль
  function toggleProfilePanel() {
    if (profilePanel.classList.contains("visible")) {
      profilePanel.classList.remove("visible");
      profilePanel.setAttribute("aria-hidden", "true");
    } else {
      profilePanel.classList.add("visible");
      profilePanel.setAttribute("aria-hidden", "false");
      // Закроем мебель если открыт
      furniturePanel.classList.remove("visible");
      furniturePanel.setAttribute("aria-hidden", "true");
    }
  }

  // Обновить профиль из инпутов
  function updateProfileFromInputs() {
    profile.nickname = profileNicknameInput.value.trim().substring(0, 25);
    profile.avatarText = profileAvatarTextInput.value.trim().substring(0, 2) || "А";
    profile.avatarBgColor = profileAvatarBgColorInput.value;

    updateAvatarPreview();
  }

  // --- События ---
  prevRoomBtn.addEventListener("click", () => changeRoom("prev"));
  nextRoomBtn.addEventListener("click", () => changeRoom("next"));
  addRoomBtn.addEventListener("click", () => addRoom());

  btnFurniture.addEventListener("click", () => toggleFurniturePanel());
  btnProfile.addEventListener("click", () => toggleProfilePanel());

  closeFurnitureBtn.addEventListener("click", () => {
    furniturePanel.classList.remove("visible");
    furniturePanel.setAttribute("aria-hidden", "true");
  });

  closeProfileBtn.addEventListener("click", () => {
    profilePanel.classList.remove("visible");
    profilePanel.setAttribute("aria-hidden", "true");
  });

  profileNicknameInput.addEventListener("input", updateProfileFromInputs);
  profileAvatarTextInput.addEventListener("input", updateProfileFromInputs);
  profileAvatarBgColorInput.addEventListener("input", updateProfileFromInputs);

  // Навигация комнат стрелками клавиатуры
  document.addEventListener("keydown", (e) => {
    if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;
    if (e.key === "ArrowLeft") changeRoom("prev");
    if (e.key === "ArrowRight") changeRoom("next");
    if (e.key.toLowerCase() === "m") toggleFurniturePanel();
    if (e.key.toLowerCase() === "p") toggleProfilePanel();
  });

  // Инициализация
  renderCurrentRoom();
  updateAvatarPreview();
</script>
<script>
// --- Мебель ---

// Пример базы мебели (id, название, тип, изображение или стиль)
const furnitureCatalog = [
  {
    id: "chair01",
    name: "Кресло",
    type: "seat",
    texture: "🪑", // В будущем заменить на изображения/спрайты
  },
  {
    id: "table01",
    name: "Стол",
    type: "table",
    texture: "🛋️",
  },
  {
    id: "lamp01",
    name: "Лампа",
    type: "light",
    texture: "💡",
  },
  {
    id: "rug01",
    name: "Ковер",
    type: "floorDecoration",
    texture: "🧸",
  },
  {
    id: "bed01",
    name: "Кровать",
    type: "bed",
    texture: "🛏️",
  },
];

// Объект с текущей мебелью для каждой комнаты
// rooms[currentRoomIndex].furniture будет массивом объектов с добавленной мебелью
// Каждый объект мебели в комнате содержит: id, x, y, rotation (0, 90, 180, 270), layer
// для простоты позиция x,y - в пикселях или в процентах (позже уточним)

function createFurnitureInstance(catalogItem) {
  return {
    id: catalogItem.id,
    name: catalogItem.name,
    type: catalogItem.type,
    texture: catalogItem.texture,
    x: 50, // стартовая позиция по центру комнаты
    y: 50,
    rotation: 0,
    layer: 0,
  };
}

// Отрисовка мебели в комнате
function renderFurniture() {
  const room = rooms[currentRoomIndex];
  const furnitureContainer = document.getElementById("furnitureContainer");
  furnitureContainer.innerHTML = ""; // Очистить

  // Сортируем по layer, чтобы рисовать снизу вверх
  const sortedFurniture = [...room.furniture].sort((a, b) => a.layer - b.layer);

  sortedFurniture.forEach((item, index) => {
    const div = document.createElement("div");
    div.classList.add("furniture-item");
    div.style.position = "absolute";
    div.style.left = item.x + "%";
    div.style.top = item.y + "%";
    div.style.transform = `rotate(${item.rotation}deg)`;
    div.style.zIndex = 100 + item.layer; // чтобы слои были выше фона

    div.textContent = item.texture;
    div.title = item.name;

    // Добавляем обработчики кликов для выбора
    div.addEventListener("click", (e) => {
      e.stopPropagation();
      selectFurniture(index);
    });

    furnitureContainer.appendChild(div);
  });
}

// Выбранный элемент мебели (индекс в массиве current комнаты)
let selectedFurnitureIndex = null;

function selectFurniture(index) {
  selectedFurnitureIndex = index;
  renderFurnitureControls();
}

// Отрисовка панели управления выбранной мебелью
function renderFurnitureControls() {
  const controls = document.getElementById("furnitureControls");
  controls.innerHTML = "";

  if (selectedFurnitureIndex === null) {
    controls.textContent = "Выберите мебель в комнате для управления.";
    return;
  }

  const room = rooms[currentRoomIndex];
  const item = room.furniture[selectedFurnitureIndex];

  const info = document.createElement("div");
  info.textContent = `Выбрана: ${item.name}`;
  controls.appendChild(info);

  // Кнопка поднять слой
  const btnUp = document.createElement("button");
  btnUp.textContent = "Поднять слой";
  btnUp.addEventListener("click", () => {
    if (item.layer < 100) {
      item.layer++;
      renderFurniture();
      renderFurnitureControls();
    }
  });
  controls.appendChild(btnUp);

  // Кнопка опустить слой
  const btnDown = document.createElement("button");
  btnDown.textContent = "Опустить слой";
  btnDown.addEventListener("click", () => {
    if (item.layer > 0) {
      item.layer--;
      renderFurniture();
      renderFurnitureControls();
    }
  });
  controls.appendChild(btnDown);

  // Поворот влево
  const btnRotateLeft = document.createElement("button");
  btnRotateLeft.textContent = "Повернуть влево";
  btnRotateLeft.addEventListener("click", () => {
    item.rotation = (item.rotation - 90 + 360) % 360;
    renderFurniture();
    renderFurnitureControls();
  });
  controls.appendChild(btnRotateLeft);

  // Поворот вправо
  const btnRotateRight = document.createElement("button");
  btnRotateRight.textContent = "Повернуть вправо";
  btnRotateRight.addEventListener("click", () => {
    item.rotation = (item.rotation + 90) % 360;
    renderFurniture();
    renderFurnitureControls();
  });
  controls.appendChild(btnRotateRight);

  // Удалить мебель
  const btnDelete = document.createElement("button");
  btnDelete.textContent = "Удалить мебель";
  btnDelete.addEventListener("click", () => {
    room.furniture.splice(selectedFurnitureIndex, 1);
    selectedFurnitureIndex = null;
    renderFurniture();
    renderFurnitureControls();
  });
  controls.appendChild(btnDelete);
}

// Добавление мебели в комнату из каталога
function addFurnitureById(furnitureId) {
  const catalogItem = furnitureCatalog.find((f) => f.id === furnitureId);
  if (!catalogItem) return;

  const newFurniture = createFurnitureInstance(catalogItem);
  rooms[currentRoomIndex].furniture.push(newFurniture);
  selectedFurnitureIndex = rooms[currentRoomIndex].furniture.length - 1;

  renderFurniture();
  renderFurnitureControls();
}

// Отрисовка каталога мебели в панели мебели
function renderFurnitureCatalog() {
  const catalogContainer = document.getElementById("furnitureCatalog");
  catalogContainer.innerHTML = "";

  furnitureCatalog.forEach((item) => {
    const btn = document.createElement("button");
    btn.classList.add("furniture-catalog-item");
    btn.textContent = item.name + " " + item.texture;
    btn.title = item.name;

    btn.addEventListener("click", () => {
      addFurnitureById(item.id);
    });

    catalogContainer.appendChild(btn);
  });
}

// Перемещение мебели мышкой (простая логика)
let dragFurnitureIndex = null;
let dragOffsetX = 0;
let dragOffsetY = 0;

const furnitureContainer = document.getElementById("furnitureContainer");

furnitureContainer.addEventListener("mousedown", (e) => {
  const target = e.target;
  if (!target.classList.contains("furniture-item")) return;

  // Найти индекс мебели по порядку в контейнере
  const children = Array.from(furnitureContainer.children);
  const index = children.indexOf(target);

  if (index === -1) return;

  dragFurnitureIndex = index;
  const rect = target.getBoundingClientRect();
  dragOffsetX = e.clientX - rect.left;
  dragOffsetY = e.clientY - rect.top;

  document.body.style.userSelect = "none"; // Запретить выделение текста при перетаскивании
});

document.addEventListener("mouseup", () => {
  dragFurnitureIndex = null;
  document.body.style.userSelect = "auto";
});

document.addEventListener("mousemove", (e) => {
  if (dragFurnitureIndex === null) return;

  const room = rooms[currentRoomIndex];
  const item = room.furniture[dragFurnitureIndex];

  // Рассчитать новые координаты в процентах относительно контейнера
  const containerRect = furnitureContainer.getBoundingClientRect();
  let newX = ((e.clientX - containerRect.left - dragOffsetX) / containerRect.width) * 100;
  let newY = ((e.clientY - containerRect.top - dragOffsetY) / containerRect.height) * 100;

  // Ограничим, чтобы не выходить за границы
  newX = Math.min(95, Math.max(0, newX));
  newY = Math.min(95, Math.max(0, newY));

  item.x = newX;
  item.y = newY;

  renderFurniture();
  renderFurnitureControls();
});

// При загрузке рендер каталога мебели
renderFurnitureCatalog();
renderFurniture();

</script>

<style>
/* Стили для мебели */
#furnitureContainer {
  position: relative;
  width: 100%;
  height: 60vh;
  border: 2px solid #ccc;
  background-color: #e0e0e0;
  margin-top: 10px;
  overflow: hidden;
  user-select: none;
}

.furniture-item {
  cursor: pointer;
  font-size: 24px;
  transition: transform 0.2s ease;
  user-select: none;
  width: 40px;
  height: 40px;
  text-align: center;
  line-height: 40px;
  border-radius: 6px;
  background-color: rgba(255 255 255 / 0.8);
  box-shadow: 0 0 3px rgba(0,0,0,0.2);
  position: absolute;
}

#furnitureControls {
  margin-top: 10px;
  padding: 10px;
  background-color: #f0f0f5;
  border-radius: 8px;
  box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
  min-height: 130px;
}

#furnitureCatalog {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 10px;
}

.furniture-catalog-item {
  padding: 6px 12px;
  background-color: #d8e3f0;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  user-select: none;
  transition: background-color 0.3s ease;
}

.furniture-catalog-item:hover {
  background-color: #a8c1ff;
}
</style>
<script>
// --- Обои и полы ---

// Узоры обоев (название + символы для текстуры)
const wallpaperPatterns = {
  "denseSquares": "■■■■■■",
  "circlesWithGaps": "◍ ◍ ◍ ◍",
  "rareSymbols": "ꙮ ꙮ ꙮ",
  "densePatterns": "ↈↈↈↈↈ",
  "stars": "※ ※ ※ ※",
  "verticalCircles": "◯\n◯\n◯",
  "semiCircles": "∪ ∪ ∪ ∪",
};

// Узоры пола
const floorPatterns = {
  "woodenBoards": "||||||||",
  "stones": "⨷ ⨷ ⨷",
  "carpet": ":::::::",
  "tiles": "⧫ ⧫ ⧫ ⧫",
  "softGradient": "░░░░░░",
  "waves": "≈≈≈≈≈",
};

// По умолчанию в комнатах уже есть обои и пол (в rooms[currentRoomIndex])

// Получить DOM элементы выбора
const wallpaperPatternSelect = document.getElementById("wallpaperPatternSelect");
const wallpaperColorInput = document.getElementById("wallpaperColorInput");
const wallpaperPatternColorInput = document.getElementById("wallpaperPatternColorInput");

const floorPatternSelect = document.getElementById("floorPatternSelect");
const floorColorInput = document.getElementById("floorColorInput");

// Инициализация селектов узоров
function initPatternSelectors() {
  // Обои
  Object.entries(wallpaperPatterns).forEach(([key, val]) => {
    const option = document.createElement("option");
    option.value = key;
    option.textContent = key;
    wallpaperPatternSelect.appendChild(option);
  });

  // Полы
  Object.entries(floorPatterns).forEach(([key, val]) => {
    const option = document.createElement("option");
    option.value = key;
    option.textContent = key;
    floorPatternSelect.appendChild(option);
  });
}

// Обновить обои комнаты по выбору
function updateWallpaper() {
  const room = rooms[currentRoomIndex];
  room.wallpaperPattern = wallpaperPatternSelect.value;
  room.wallpaperColor = wallpaperColorInput.value;
  room.wallpaperPatternColor = wallpaperPatternColorInput.value;

  renderRoomBackground();
}

// Обновить пол комнаты по выбору
function updateFloor() {
  const room = rooms[currentRoomIndex];
  room.floorPattern = floorPatternSelect.value;
  room.floorColor = floorColorInput.value;

  renderRoomBackground();
}

// Отрисовка фона комнаты (обои и пол)
function renderRoomBackground() {
  const room = rooms[currentRoomIndex];

  // Задний фон — обои (узор + цвет)
  const wallpaperDiv = document.getElementById("wallpaperBackground");
  const wallpaperPattern = wallpaperPatterns[room.wallpaperPattern] || wallpaperPatterns["denseSquares"];
  wallpaperDiv.style.color = room.wallpaperPatternColor || "#999";
  wallpaperDiv.style.backgroundColor = room.wallpaperColor || "#fff";

  // Пишем повторяющийся узор (просто повторяем символы в блоке)
  wallpaperDiv.textContent = wallpaperPattern.repeat(50);

  // Плавная смена цвета
  wallpaperDiv.style.transition = "background-color 0.5s ease, color 0.5s ease";

  // Пол
  const floorDiv = document.getElementById("floorBackground");
  const floorPattern = floorPatterns[room.floorPattern] || floorPatterns["woodenBoards"];
  floorDiv.style.color = "#6b4c3b"; // базовый цвет узора пола, можно улучшить
  floorDiv.style.backgroundColor = room.floorColor || "#ccc";

  floorDiv.textContent = floorPattern.repeat(50);
  floorDiv.style.transition = "background-color 0.5s ease, color 0.5s ease";
}

// Обработчики событий изменения выбора
wallpaperPatternSelect.addEventListener("change", updateWallpaper);
wallpaperColorInput.addEventListener("input", updateWallpaper);
wallpaperPatternColorInput.addEventListener("input", updateWallpaper);

floorPatternSelect.addEventListener("change", updateFloor);
floorColorInput.addEventListener("input", updateFloor);

// Инициализация и отрисовка при загрузке
initPatternSelectors();

// Задать значения селектов и инпутов из текущей комнаты
function loadRoomPatternsToControls() {
  const room = rooms[currentRoomIndex];

  wallpaperPatternSelect.value = room.wallpaperPattern || "denseSquares";
  wallpaperColorInput.value = room.wallpaperColor || "#ffffff";
  wallpaperPatternColorInput.value = room.wallpaperPatternColor || "#999999";

  floorPatternSelect.value = room.floorPattern || "woodenBoards";
  floorColorInput.value = room.floorColor || "#cccccc";
}

loadRoomPatternsToControls();
renderRoomBackground();

</script>

<style>
/* Стили для обоев и пола */
#wallpaperBackground {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 65%;
  overflow: hidden;
  font-size: 24px;
  line-height: 24px;
  user-select: none;
  white-space: nowrap;
  word-wrap: normal;
  letter-spacing: 2px;
  opacity: 0.3;
  pointer-events: none;
}

#floorBackground {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 35%;
  overflow: hidden;
  font-size: 28px;
  line-height: 28px;
  user-select: none;
  white-space: nowrap;
  word-wrap: normal;
  letter-spacing: 4px;
  opacity: 0.4;
  pointer-events: none;
}

/* Панель управления обоями и полом */
#wallpaperControls, #floorControls {
  margin-top: 15px;
  background-color: #fafafa;
  padding: 10px;
  border-radius: 10px;
  box-shadow: inset 0 0 8px #ddd;
  max-width: 480px;
  font-family: Arial, sans-serif;
}

label {
  display: block;
  margin-top: 8px;
  font-weight: 600;
  color: #444;
}

input[type=color], select {
  margin-top: 4px;
  padding: 5px;
  width: 100%;
  box-sizing: border-box;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 16px;
}
</style>

<!-- HTML для панели обоев и пола -->
<div id="wallpaperBackground"></div>
<div id="floorBackground"></div>

<div id="wallpaperControls">
  <h3>Обои</h3>
  <label for="wallpaperPatternSelect">Узор:</label>
  <select id="wallpaperPatternSelect"></select>
  <label for="wallpaperColorInput">Цвет обоев:</label>
  <input type="color" id="wallpaperColorInput" value="#ffffff" />
  <label for="wallpaperPatternColorInput">Цвет узора:</label>
  <input type="color" id="wallpaperPatternColorInput" value="#999999" />
</div>

<div id="floorControls">
  <h3>Пол</h3>
  <label for="floorPatternSelect">Узор пола:</label>
  <select id="floorPatternSelect"></select>
  <label for="floorColorInput">Цвет пола:</label>
  <input type="color" id="floorColorInput" value="#cccccc" />
</div>
<!-- 4-я часть: Профиль, Друзья, Ссылка, Музыка -->

<!-- Вспомогательные стили -->
<style>
  /* Основной контейнер профиля */
  #profileOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(6px);
    display: none;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #333;
    z-index: 1000;
  }

  #profileHeader {
    width: 100%;
    max-width: 600px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  #profileHeader h2 {
    margin: 0;
    font-weight: 700;
    font-size: 1.8rem;
  }

  #profileCloseBtn {
    cursor: pointer;
    font-size: 1.5rem;
    padding: 5px 10px;
    border: none;
    background: #e3e3e3;
    border-radius: 8px;
    transition: background-color 0.3s ease;
  }
  #profileCloseBtn:hover {
    background: #cfcfcf;
  }

  /* Навигация внутри профиля */
  #profileNav {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }
  #profileNav button {
    background: #ececec;
    border: none;
    border-radius: 6px;
    padding: 8px 14px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s ease;
  }
  #profileNav button.active,
  #profileNav button:hover {
    background: #b6d7a8;
    color: #2f521e;
  }

  /* Секции */
  .profileSection {
    width: 100%;
    max-width: 600px;
    display: none;
    flex-direction: column;
    gap: 15px;
  }
  .profileSection.active {
    display: flex;
  }

  /* Аватарка */
  #avatarPreview {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    font-size: 50px;
    color: #fff;
    text-align: center;
    line-height: 100px;
    user-select: none;
    font-weight: 700;
    margin-bottom: 10px;
    position: relative;
  }

  /* Цвет фона аватарки */
  #avatarBgColor {
    width: 100%;
    max-width: 150px;
    height: 36px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
  }

  /* Текстовое поле для символов аватарки */
  #avatarSymbolInput {
    width: 100%;
    max-width: 150px;
    padding: 6px 8px;
    font-size: 28px;
    font-weight: 700;
    border: 2px solid #b6d7a8;
    border-radius: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
    user-select: text;
  }

  /* Никнейм */
  #nicknameInput {
    padding: 6px 8px;
    font-size: 18px;
    border-radius: 8px;
    border: 2px solid #b6d7a8;
    max-width: 300px;
  }

  /* ID и кнопки */
  #profileIdSection {
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: monospace;
    font-size: 14px;
    margin-top: 6px;
  }

  .btnSmall {
    background: #b6d7a8;
    border: none;
    padding: 6px 10px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    color: #2f521e;
    transition: background-color 0.3s ease;
  }
  .btnSmall:hover {
    background: #94b66d;
  }

  /* Список друзей */
  #friendsList {
    max-height: 280px;
    overflow-y: auto;
    border: 1px solid #c4d6a6;
    border-radius: 10px;
    padding: 10px;
    background: #f9fcef;
  }
  .friendItem {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 6px 8px;
    border-radius: 8px;
    background: #e6f1d5;
    margin-bottom: 8px;
  }
  .friendAvatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    font-weight: 700;
    font-size: 24px;
    color: white;
    text-align: center;
    line-height: 48px;
    user-select: none;
    flex-shrink: 0;
  }
  .friendInfo {
    flex-grow: 1;
    font-weight: 600;
  }
  .friendButtons {
    display: flex;
    gap: 8px;
  }
  .friendButtons button {
    background: #a3c87f;
    border: none;
    padding: 6px 10px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 12px;
    color: #2f521e;
    transition: background-color 0.3s ease;
  }
  .friendButtons button:hover {
    background: #7aa23d;
  }

  /* Добавление друга */
  #addFriendSection {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    align-items: center;
  }
  #addFriendInput {
    flex-grow: 1;
    padding: 6px 8px;
    font-size: 16px;
    border-radius: 8px;
    border: 2px solid #b6d7a8;
  }
  #addFriendBtn {
    padding: 8px 14px;
    font-weight: 700;
    border-radius: 8px;
    border: none;
    background: #94b66d;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #addFriendBtn:hover:not(:disabled) {
    background: #7aa23d;
  }
  #addFriendBtn:disabled {
    background: #b6d7a8;
    cursor: default;
  }

  /* Сообщения */
  #profileMessage {
    margin-top: 10px;
    font-weight: 600;
    font-size: 14px;
    color: #3b6619;
  }

  /* Ссылка на квартиру */
  #linkSection {
    margin-top: 15px;
    padding: 10px;
    background: #d9e8b9;
    border-radius: 10px;
    font-family: monospace;
    word-break: break-all;
    user-select: all;
  }
  #generateLinkBtn {
    margin-top: 10px;
    padding: 8px 14px;
    border: none;
    border-radius: 8px;
    background: #7aa23d;
    color: white;
    cursor: pointer;
    font-weight: 700;
    transition: background-color 0.3s ease;
  }
  #generateLinkBtn:hover {
    background: #59812a;
  }

  /* Музыкальный плеер */
  #musicPlayer {
    margin-top: 20px;
    background: #eef4de;
    padding: 12px 20px;
    border-radius: 12px;
    max-width: 600px;
  }
  #musicControls {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  #musicSelect {
    flex-grow: 1;
    padding: 6px 8px;
    font-size: 16px;
    border-radius: 8px;
    border: 2px solid #b6d7a8;
  }
  #musicVolume {
    width: 100px;
  }
  #musicButtons button {
    padding: 8px 14px;
    border: none;
    border-radius: 8px;
    background: #94b66d;
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #musicButtons button:hover {
    background: #7aa23d;
  }
</style>

<!-- Окно Профиля -->
<div id="profileOverlay" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Профиль пользователя">
  <div id="profileHeader">
    <h2>Профиль</h2>
    <button id="profileCloseBtn" aria-label="Закрыть профиль">&times;</button>
  </div>

  <nav id="profileNav" role="tablist" aria-label="Навигация по профилю">
    <button id="tabProfileBtn" role="tab" aria-selected="true" tabindex="0">Профиль</button>
    <button id="tabFriendsBtn" role="tab" aria-selected="false" tabindex="-1">Друзья</button>
    <button id="tabIDBtn" role="tab" aria-selected="false" tabindex="-1">ID</button>
  </nav>

  <!-- Секции -->
  <section id="profileSection" class="profileSection active" role="tabpanel" tabindex="0" aria-labelledby="tabProfileBtn">
    <div>
      <div id="avatarPreview" aria-label="Предпросмотр аватарки" tabindex="0" role="img"></div>

      <label for="avatarSymbolInput">Текст на аватарке (макс 2 символа):</label>
      <input type="text" id="avatarSymbolInput" maxlength="2" aria-describedby="avatarSymbolDesc" autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"/>

      <small id="avatarSymbolDesc">Можно буквы, цифры или стикеры</small>

      <label for="avatarBgColor">Цвет фона аватарки:</label>
      <input type="color" id="avatarBgColor" value="#94b66d" aria-describedby="avatarBgColorDesc" />
      <small id="avatarBgColorDesc">Выберите цвет фона аватарки</small>
    </div>

    <div>
      <label for="nicknameInput">Никнейм (макс 25 символов):</label>
      <input type="text" id="nicknameInput" maxlength="25" aria-describedby="nicknameDesc" autocomplete="off" autocorrect="off" autocapitalize="words" spellcheck="false" />
      <small id="nicknameDesc">Можно менять не чаще, чем раз в час</small>
    </div>

    <div id="profileIdSection" aria-live="polite" aria-atomic="true">
      <span>ID: <span id="profileIDText"></span></span>
      <button class="btnSmall" id="copyProfileIDBtn" aria-label="Скопировать ID профиля">Копировать ID</button>
    </div>

    <button id="saveProfileBtn" class="btnSmall" aria-label="Сохранить изменения профиля">Сохранить профиль</button>

    <div id="profileMessage" role="alert" aria-live="assertive"></div>

    <div id="linkSection" aria-label="Генерация ссылки на квартиру">
      <label>Ссылка на квартиру:</label>
      <textarea id="apartmentLink" rows="2" readonly style="width:100%; resize:none; border-radius:8px; border: 2px solid #b6d7a8; padding:8px; font-family: monospace;"></textarea>
      <button id="generateLinkBtn" aria-label="Сгенерировать ссылку на квартиру">Сгенерировать ссылку</button>
    </div>
  </section>

  <section id="friendsSection" class="profileSection" role="tabpanel" tabindex="0" aria-labelledby="tabFriendsBtn">
    <h3>Друзья</h3>

    <div id="friendsList" aria-live="polite" aria-relevant="additions removals"></div>

    <div id="addFriendSection">
      <input type="text" id="addFriendInput" placeholder="Введите ID друга" aria-label="ID друга" autocomplete="off" />
      <button id="addFriendBtn" disabled>Добавить друга</button>
    </div>

    <div id="friendsMessage" role="alert" aria-live="assertive"></div>
  </section>

  <section id="idSection" class="profileSection" role="tabpanel" tabindex="0" aria-labelledby="tabIDBtn">
    <h3>Информация профиля</h3>
    <p><strong>Никнейм:</strong> <span id="idNickname"></span></p>
    <p><strong>ID:</strong> <span id="idID"></span></p>
    <p><strong>Аватарка:</strong></p>
    <div id="idAvatar" style="width: 80px; height: 80px; border-radius: 50%; font-weight: 700; font-size: 40px; color: white; text-align: center; line-height: 80px; user-select: none;"></div>
  </section>

  <section id="musicSection" class="profileSection" role="tabpanel" tabindex="0" aria-labelledby="tabMusicBtn" style="display:none;">
    <!-- Можно добавить если нужно -->
  </section>

  <!-- Музыкальный плеер внизу профиля -->
  <div id="musicPlayer" aria-label="Музыкальный плеер">
    <select id="musicSelect" aria-label="Выбор песни">
      <option value="1.mp3">Песня 1</option>
      <option value="2.mp3">Песня 2</option>
      <option value="3.mp3">Песня 3</option>
      <option value="4.mp3">Песня 4</option>
      <option value="5.mp3">Песня 5</option>
    </select>
    <input id="musicVolume" type="range" min="0" max="1" step="0.01" aria-label="Громкость" value="0.5"/>
    <div id="musicButtons">
      <button id="musicPlayBtn" aria-label="Воспроизвести музыку">▶</button>
      <button id="musicPauseBtn" aria-label="Пауза">⏸</button>
      <button id="musicRandomBtn" aria-label="Случайная песня">🔀</button>
    </div>
  </div>
</div>

<script>
(() => {
  // Ключи для localStorage
  const STORAGE_PROFILE = 'tbw_profile';
  const STORAGE_FRIENDS = 'tbw_friends';
  const STORAGE_APARTMENT = 'tbw_apartment';

  // Элементы интерфейса
  const profileOverlay = document.getElementById('profileOverlay');
  const profileCloseBtn = document.getElementById('profileCloseBtn');

  const tabProfileBtn = document.getElementById('tabProfileBtn');
  const tabFriendsBtn = document.getElementById('tabFriendsBtn');
  const tabIDBtn = document.getElementById('tabIDBtn');

  const profileSection = document.getElementById('profileSection');
  const friendsSection = document.getElementById('friendsSection');
  const idSection = document.getElementById('idSection');

  const avatarPreview = document.getElementById('avatarPreview');
  const avatarSymbolInput = document.getElementById('avatarSymbolInput');
  const avatarBgColor = document.getElementById('avatarBgColor');

  const nicknameInput = document.getElementById('nicknameInput');
  const profileIDText = document.getElementById('profileIDText');
  const copyProfileIDBtn = document.getElementById('copyProfileIDBtn');
  const saveProfileBtn = document.getElementById('saveProfileBtn');
  const profileMessage = document.getElementById('profileMessage');

  const friendsList = document.getElementById('friendsList');
  const addFriendInput = document.getElementById('addFriendInput');
  const addFriendBtn = document.getElementById('addFriendBtn');
  const friendsMessage = document.getElementById('friendsMessage');

  const idNickname = document.getElementById('idNickname');
  const idID = document.getElementById('idID');
  const idAvatar = document.getElementById('idAvatar');

  const apartmentLink = document.getElementById('apartmentLink');
  const generateLinkBtn = document.getElementById('generateLinkBtn');

  const musicSelect = document.getElementById('musicSelect');
  const musicVolume = document.getElementById('musicVolume');
  const musicPlayBtn = document.getElementById('musicPlayBtn');
  const musicPauseBtn = document.getElementById('musicPauseBtn');
  const musicRandomBtn = document.getElementById('musicRandomBtn');

  // Текущий профиль и друзья
  let profile = {
    nickname: '',
    avatarSymbol: '',
    avatarBg: '#94b66d',
    id: '',
    lastNicknameChange: 0,
    lastAvatarChange: 0,
  };
  let friends = [];

  // Генератор простого ID
  function generateID(len = 6) {
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let id = '';
    for (let i=0; i<len; i++) {
      id += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return id;
  }

  // Сохранять профиль в localStorage
  function saveProfile() {
    localStorage.setItem(STORAGE_PROFILE, JSON.stringify(profile));
  }
  // Загрузить профиль из localStorage
  function loadProfile() {
    const data = localStorage.getItem(STORAGE_PROFILE);
    if (data) {
      try {
        profile = JSON.parse(data);
      } catch {
        profile = {...profile};
      }
    }
    if (!profile.id) profile.id = generateID(7);
  }

  // Сохранять друзей
  function saveFriends() {
    localStorage.setItem(STORAGE_FRIENDS, JSON.stringify(friends));
  }
  // Загрузить друзей
  function loadFriends() {
    const data = localStorage.getItem(STORAGE_FRIENDS);
    if (data) {
      try {
        friends = JSON.parse(data);
      } catch {
        friends = [];
      }
    }
  }

  // Обновить аватарку превью
  function updateAvatarPreview() {
    avatarPreview.style.backgroundColor = profile.avatarBg;
    avatarPreview.textContent = profile.avatarSymbol || '😊';
  }
  // Обновить инфу в профиле
  function updateProfileUI() {
    avatarSymbolInput.value = profile.avatarSymbol || '';
    avatarBgColor.value = profile.avatarBg;
    nicknameInput.value = profile.nickname;
    profileIDText.textContent = profile.id;

    idNickname.textContent = profile.nickname || '(нет ника)';
    idID.textContent = profile.id;
    idAvatar.style.backgroundColor = profile.avatarBg;
    idAvatar.textContent = profile.avatarSymbol || '😊';
  }

  // Обновить список друзей
  function updateFriendsList() {
    friendsList.innerHTML = '';
    if (friends.length === 0) {
      friendsList.innerHTML = '<p>Список друзей пуст.</p>';
      return;
    }
    friends.forEach(friend => {
      const friendEl = document.createElement('div');
      friendEl.className = 'friendItem';
      friendEl.setAttribute('data-id', friend.id);

      const friendAvatar = document.createElement('div');
      friendAvatar.className = 'friendAvatar';
      friendAvatar.style.backgroundColor = friend.avatarBg || '#94b66d';
      friendAvatar.textContent = friend.avatarSymbol || '😊';

      const friendInfo = document.createElement('div');
      friendInfo.className = 'friendInfo';
      friendInfo.textContent = friend.nickname || '(без имени)';

      const buttonsDiv = document.createElement('div');
      buttonsDiv.className = 'friendButtons';

      // Кнопка копировать ID
      const copyIDBtn = document.createElement('button');
      copyIDBtn.textContent = '📋';
      copyIDBtn.title = 'Копировать ID';
      copyIDBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(friend.id);
        friendsMessage.textContent = `ID друга "${friend.nickname}" скопирован.`;
        clearMessageLater(friendsMessage);
      });

      // Кнопка удалить из друзей
      const delBtn = document.createElement('button');
      delBtn.textContent = '❌';
      delBtn.title = 'Удалить из друзей';
      delBtn.addEventListener('click', () => {
        if (confirm(`Удалить "${friend.nickname}" из друзей?`)) {
          friends = friends.filter(f => f.id !== friend.id);
          saveFriends();
          updateFriendsList();
          friendsMessage.textContent = `Друг "${friend.nickname}" удалён.`;
          clearMessageLater(friendsMessage);
        }
      });

      buttonsDiv.appendChild(copyIDBtn);
      buttonsDiv.appendChild(delBtn);

      friendEl.appendChild(friendAvatar);
      friendEl.appendChild(friendInfo);
      friendEl.appendChild(buttonsDiv);

      friendsList.appendChild(friendEl);
    });
  }

  // Вспомогательная функция очистки сообщений
  function clearMessageLater(element, delay = 4000) {
    setTimeout(() => {
      if (element) element.textContent = '';
    }, delay);
  }

  // Проверка ограничений изменения ника и аватарки
  function canChangeNickname() {
    const now = Date.now();
    return (now - profile.lastNicknameChange) > (1000 * 60 * 60); // 1 час
  }
  function canChangeAvatar() {
    const now = Date.now();
    return (now - profile.lastAvatarChange) > (1000 * 60 * 10); // 10 минут
  }

  // Обработчик сохранения профиля
  saveProfileBtn.addEventListener('click', () => {
    const newNickname = nicknameInput.value.trim();
    const newAvatarSymbol = avatarSymbolInput.value.trim().toUpperCase();
    const newAvatarBg = avatarBgColor.value;

    // Проверки и валидация
    if (newNickname.length === 0) {
      profileMessage.textContent = 'Никнейм не может быть пустым.';
      return;
    }
    if (newNickname.length > 25) {
      profileMessage.textContent = 'Никнейм слишком длинный.';
      return;
    }
    if (newAvatarSymbol.length > 2) {
      profileMessage.textContent = 'Аватарка: максимум 2 символа.';
      return;
    }
    if (newNickname !== profile.nickname && !canChangeNickname()) {
      profileMessage.textContent = 'Ник можно менять не чаще раза в час.';
      return;
    }
    if ((newAvatarSymbol !== profile.avatarSymbol || newAvatarBg !== profile.avatarBg) && !canChangeAvatar()) {
      profileMessage.textContent = 'Аватарку можно менять не чаще чем раз в 10 минут.';
      return;
    }

    // Обновляем профиль
    if (newNickname !== profile.nickname) {
      profile.nickname = newNickname;
      profile.lastNicknameChange = Date.now();
    }
    if (newAvatarSymbol !== profile.avatarSymbol || newAvatarBg !== profile.avatarBg) {
      profile.avatarSymbol = newAvatarSymbol || '😊';
      profile.avatarBg = newAvatarBg;
      profile.lastAvatarChange = Date.now();
    }
    saveProfile();
    updateProfileUI();
    profileMessage.textContent = 'Профиль сохранён.';
    clearMessageLater(profileMessage);
  });

  // При изменении аватарки обновлять превью
  avatarSymbolInput.addEventListener('input', () => {
    profile.avatarSymbol = avatarSymbolInput.value.trim().toUpperCase() || '😊';
    updateAvatarPreview();
  });
  avatarBgColor.addEventListener('input', () => {
    profile.avatarBg = avatarBgColor.value;
    updateAvatarPreview();
  });

  // Обработчик копирования ID
  copyProfileIDBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(profile.id);
    profileMessage.textContent = 'ID профиля скопирован.';
    clearMessageLater(profileMessage);
  });

  // Навигация по табам
  function setActiveTab(tab) {
    tabProfileBtn.setAttribute('aria-selected', 'false');
    tabProfileBtn.tabIndex = -1;
    tabFriendsBtn.setAttribute('aria-selected', 'false');
    tabFriendsBtn.tabIndex = -1;
    tabIDBtn.setAttribute('aria-selected', 'false');
    tabIDBtn.tabIndex = -1;

    profileSection.classList.remove('active');
    friendsSection.classList.remove('active');
    idSection.classList.remove('active');

    if (tab === 'profile') {
      tabProfileBtn.setAttribute('aria-selected', 'true');
      tabProfileBtn.tabIndex = 0;
      profileSection.classList.add('active');
      profileSection.focus();
    } else if (tab === 'friends') {
      tabFriendsBtn.setAttribute('aria-selected', 'true');
      tabFriendsBtn.tabIndex = 0;
      friendsSection.classList.add('active');
      friendsSection.focus();
    } else if (tab === 'id') {
      tabIDBtn.setAttribute('aria-selected', 'true');
      tabIDBtn.tabIndex = 0;
      idSection.classList.add('active');
      idSection.focus();
    }
  }
  tabProfileBtn.addEventListener('click', () => setActiveTab('profile'));
  tabFriendsBtn.addEventListener('click', () => setActiveTab('friends'));
  tabIDBtn.addEventListener('click', () => setActiveTab('id'));

  // Открыть / Закрыть профиль
  function openProfile() {
    profileOverlay.style.display = 'flex';
    profileOverlay.setAttribute('aria-hidden', 'false');
    updateProfileUI();
    updateFriendsList();
    setActiveTab('profile');
  }
  function closeProfile() {
    profileOverlay.style.display = 'none';
    profileOverlay.setAttribute('aria-hidden', 'true');
  }
  profileCloseBtn.addEventListener('click', closeProfile);

  
